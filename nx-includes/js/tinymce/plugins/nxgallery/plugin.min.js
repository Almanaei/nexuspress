tinymce.PluginManager.add("nxgallery",function(d){function t(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e){return t="nx-gallery",n=e,n=window.encodeURIComponent(e),'<img src="'+tinymce.Env.transparentSrc+'" class="nx-media mceItem '+t+'" data-nx-media="'+n+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />';var t,n})}function n(e){return e.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(e,t){t=t,n="data-nx-media";var n,t=(n=new RegExp(n+'="([^"]+)"').exec(t))?window.decodeURIComponent(n[1]):"";return t?"<p>"+t+"</p>":e})}function o(t){var n,a,e;"IMG"===t.nodeName&&"undefined"!=typeof nx&&nx.media&&(e=window.decodeURIComponent(d.dom.getAttrib(t,"data-nx-media")),d.dom.hasClass(t,"nx-gallery"))&&nx.media.gallery&&(n=nx.media.gallery,(a=n.edit(e)).state("gallery-edit").on("update",function(e){e=n.shortcode(e).string();d.dom.setAttrib(t,"data-nx-media",window.encodeURIComponent(e)),a.detach()}))}d.addCommand("NX_Gallery",function(){o(d.selection.getNode())}),d.on("mouseup",function(e){var t=d.dom,n=e.target;function a(){t.removeClass(t.select("img.nx-media-selected"),"nx-media-selected")}"IMG"===n.nodeName&&t.getAttrib(n,"data-nx-media")?2!==e.button&&(t.hasClass(n,"nx-media-selected")?o(n):(a(),t.addClass(n,"nx-media-selected"))):a()}),d.on("ResolveName",function(e){var t=d.dom,n=e.target;"IMG"===n.nodeName&&t.getAttrib(n,"data-nx-media")&&t.hasClass(n,"nx-gallery")&&(e.name="gallery")}),d.on("BeforeSetContent",function(e){d.plugins.nxview&&"undefined"!=typeof nx&&nx.mce||(e.content=t(e.content))}),d.on("PostProcess",function(e){e.get&&(e.content=n(e.content))})});